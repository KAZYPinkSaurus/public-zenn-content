---
title: "[AWS/Inf1/ECS]Neuron Coreã®ä½¿ç”¨ç‡ã‚’ç›£è¦–ã™ã‚‹ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚’ä½œã‚‹"
emoji: "ğŸ¦–"
type: "tech"
topics: ["aws","Inf1"]
published: false
---

![](https://storage.googleapis.com/zenn-user-upload/d7e797278d67-20221218.png)
*AWS Neuron*

![](https://storage.googleapis.com/zenn-user-upload/7f3283310028-20221218.png)
*ã“ã‚ŒãŒã‚„ã‚ŠãŸã„*
# å¯¾è±¡èª­è€…
ECSã§Inf1ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½¿ã£ã¦ã„ã‚‹äººã€‚
Inferetialãƒãƒƒãƒ—ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ç›£è¦–ã—ãŸã„äººã€‚
# èƒŒæ™¯
Neuron Coreã®ä½¿ç”¨ç‡ãŒCloud Watchã®ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨ã—ã¦å–å¾—ã§ãã‚‹ã“ã¨ã¯ä»¥å‰[ã“ã¡ã‚‰ã®è¨˜äº‹](https://zenn.dev/optfit/articles/c0ca6ab9056591)ã§ç¢ºèªã—ã¾ã—ãŸã€‚

ä»Šåº¦ã¯ECSã§Inf1ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’é‹ç”¨å‡ºæ¥ã‚‹ã‚ˆã†ã«ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç”¨ã„ã¦ç›£è¦–ã‚’ã—ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

# å®Ÿè¡Œç’°å¢ƒ
| ãƒã‚·ãƒ³ã‚¿ã‚¤ãƒ— | AMI |
| ---- | ---- | 
| inf1.xlarge | ECSã«æœ€é©åŒ–ã•ã‚ŒãŸInf1ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”¨AMI(amzn2-ami-ecs-inf-hvm-2.0.20221213-x86_64-ebs) | 

# æ–¹é‡
[Supervisor](https://docs.docker.jp/engine/admin/using_supervisord.html)ã‚’ç”¨ã„ã¦ãƒ—ãƒ­ã‚»ã‚¹ãŒè½ã¡ã¦ã‚‚å†èµ·å‹•ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
[ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’Cloud Watchã«é€ä¿¡ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰](https://awsdocs-neuron.readthedocs-hosted.com/en/latest/tools/neuron-sys-tools/neuron-monitor-user-guide.html#using-neuron-monitor-cloudwatch-py)ã‚’ãã®ã¾ã¾ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã¨ã—ã¦å‹•ã‹ã—ã¦ã¿ãŸã‚‰30æ™‚é–“ãã‚‰ã„ã§çµ‚äº†ã—ã¦ã—ã¾ã£ãŸãŸã‚ã§ã™ã€‚

ECSã‚¿ã‚¹ã‚¯ã®å…¨ä½“ã‚’å†èµ·å‹•ã•ã›ãŸããªã‹ã£ãŸã®ã§ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã ã‘ã‚’å†èµ·å‹•ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

# å®Ÿè£…
![](https://storage.googleapis.com/zenn-user-upload/d4007ea4754e-20221218.png)
*KAZYColorfulSaurus*

## neuron-monitorã‚’å‹•ã‹ã™ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
ãƒ‡ã‚£ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹IDã¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã‚’å…¥ã‚Œã¦ã„ã¾ã™ã€‚
ãƒ‡ã‚£ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’å¢—ã‚„ã™ã¨ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ•°ãŒå¢—ãˆã‚‹ã®ã§æ–™é‡‘ã«ã¯æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’é€ä¿¡ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€å¾Œè¿°ã™ã‚‹aws-neuron-toolsã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨`/opt/aws/neuron/bin/neuron-monitor-cloudwatch.py`ã«é…ç½®ã•ã‚Œã‚‹ã®ã§ãã¡ã‚‰ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚
:::details neuron-monitor.sh
```bash:neuron-monitor.sh
#!/bin/bash
neuron-monitor | /opt/aws/neuron/bin/neuron-monitor-cloudwatch.py  --common-dims instance_id,instance_type --region ap-northeast-1
```
:::

## Supervisor
ã‚³ãƒ³ãƒ†ãƒŠãŒçµ‚äº†ã—ã¦ã—ã¾ã‚ãªã„ã‚ˆã†ã«ãƒ‡ãƒ¼ãƒ¢ãƒ³åŒ–ã‚’offã«ã™ã‚‹è¨­å®šã‚’å…¥ã‚Œã¦ã„ã¾ã™ã€‚
:::details supervisord.conf
```:supervisord.conf
[supervisord]
nodaemon=true

[program:neuron-monitor]
command=/neuron-monitor.sh
```
:::

## Dockerfile
Inferentiaãƒãƒƒãƒ—ã«é–¢ã™ã‚‹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—ã§ãã‚‹[neuron-monitorã‚³ãƒãƒ³ãƒ‰](https://awsdocs-neuron.readthedocs-hosted.com/en/latest/tools/neuron-sys-tools/neuron-monitor-user-guide.html?highlight=neuron-monitor)ã¨ã€Cloud Watchã«ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’é€ä¿¡ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯`aws-neuron-tools`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

ãã®ãŸã‚ã€aws-neuron-toolsã®ã¿ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã—ãŸã€‚[ã“ã¡ã‚‰](https://awsdocs-neuron.readthedocs-hosted.com/en/latest/containers/docker-example/inference/Dockerfile-libmode.html#libmode-dockerfile)ã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚

Imageã®ã‚µã‚¤ã‚ºã¯ç´„125MBã§ã™ã€‚
:::details Dockerfile
```Dockerfile
FROM ubuntu:20.04

RUN apt-get update -y \
    && apt-get install -y --no-install-recommends \
    gnupg2 \
    wget \
    python3-pip \
    python3-setuptools \
    supervisor \
    &&  mkdir -p /var/log/supervisor \
    && cd /usr/local/bin \
    && pip3 --no-cache-dir install --upgrade pip \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

RUN pip3 install boto3

RUN echo "deb https://apt.repos.neuron.amazonaws.com bionic main" > /etc/apt/sources.list.d/neuron.list
RUN wget -qO - https://apt.repos.neuron.amazonaws.com/GPG-PUB-KEY-AMAZON-AWS-NEURON.PUB | apt-key add -

# Installing Neuron Tools
RUN apt-get update -y && apt-get install -y \
    aws-neuronx-tools

# Sets up Path for Neuron tools
ENV PATH="/opt/bin/:/opt/aws/neuron/bin:${PATH}"

COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf
COPY neuron-monitor.sh /neuron-monitor.sh

CMD ["/usr/bin/supervisord"]
```
:::

## ECSã®ã‚¿ã‚¹ã‚¯å®šç¾©
ã‚¿ã‚¹ã‚¯å…¨ä½“ãŒã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã«ã‚ˆã£ã¦çµ‚äº†ã•ã›ã‚‰ã‚Œãªã„ã‚ˆã†ã«essentialã‚’falseã«ã—ã¦ã„ã¾ã™ã€‚

Inferentiaãƒãƒƒãƒ—ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯linuxParametersã«è¨­å®šãŒå¿…è¦ã§ã™ã€‚[ã“ã¡ã‚‰](https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/ecs-inference.html
)ã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ã€‚

CPUåˆ©ç”¨ç‡ã¯inf1.xlargeã§è¦³å¯Ÿã—ã¦ã„ãŸã¨ã“ã‚åŸºæœ¬1%(ç´„10m)ä»¥ä¸‹ã€å¤§ããã¦5%(ç´„51m)ãã‚‰ã„ã§ã™ã€‚ãƒ¡ãƒ¢ãƒªã¯60MiBç¨‹åº¦ã§ã™ã€‚ãƒªã‚½ãƒ¼ã‚¹ã®äºˆç´„ã‚’ã™ã‚‹å ´åˆã¯å‚è€ƒã«ã—ã¦ãã ã•ã„^[äºˆç´„ã‚’ã—ãªãã¦ã‚‚å‹•ãã¾ã™]ã€‚
:::details taskdef.json
ãƒ¡ã‚¤ãƒ³ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«é–¢ã™ã‚‹éƒ¨åˆ†ã¯çœç•¥ã—ã¦ã„ã¾ã™ã€‚
```json:taskdef.json
ï¸™ç•¥ 
        {
            "name": "neuron-monitor",
            "image": "<ECRã®ãƒ‘ã‚¹>",
            "essential": false,
            "linuxParameters": {
                "capabilities": {
                    "add": [
                        "IPC_LOCK"
                    ]
                },
                "devices": [
                    {
                        "hostPath": "/dev/neuron0",
                        "containerPath": "/dev/neuron0",
                        "permissions": [
                            "read",
                            "write"
                        ]
                    }
                ]
            }
        }
ï¸™ç•¥
```
:::

## å‡ºæ¥ä¸ŠãŒã‚Š

![](https://storage.googleapis.com/zenn-user-upload/695bea1f06e3-20230108.png)
*neuron-monitorã‚³ãƒ³ãƒ†ãƒŠãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã¨ä¸€ç·’ã«èµ·å‹•ã—ã¦ã„ã‚‹æ§˜å­*
# ãŠã‚ã‚Šã«
ECSã‚¿ã‚¹ã‚¯ã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã¨ã—ã¦ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒCloud Watchã«é€ä¿¡ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

1ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã”ã¨ã«27å€‹ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨ãŒé€ä¿¡ã•ã‚Œã‚‹ã®ã§ã™ãŒã€ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¯æœ€åˆã®10,000ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¯0.30USD/æœˆã‹ã‹ã‚‹ã®ã§ã€æ¬¡å›ã¯å¿…è¦ãªãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ã¿é€ä¿¡ã™ã‚‹ã‚ˆã†ã«ã—ãŸã„ãªã¨æ€ã„ã¾ã™ã€‚
