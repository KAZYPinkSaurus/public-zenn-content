---
title: "[AWS/Inf1]Neuron Coreã®ä½¿ç”¨ç‡ã‚’ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨ã—ã¦Cloud Watchã§è¡¨ç¤ºã™ã‚‹"
emoji: "ğŸ¦–"
type: "tech"
topics: ["aws","inf1","cloudwatch"]
published: true
publication_name: "optfit_tech"
---

![](https://storage.googleapis.com/zenn-user-upload/d7e797278d67-20221218.png)
*AWS Neuron*
[@KAZYPinkSaurus](https://twitter.com/KAZYPinkSaurus)ã§ã™ã€‚

ã‚·ã‚¹ãƒ†ãƒ ã‚’é‹ç”¨ã™ã‚‹ä¸Šã§ç›£è¦–ã¯é‡è¦ã§ã™ã€‚
Inf1ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’é‹ç”¨ã™ã‚‹ãªã‚‰ã€CPUã‚„ãƒ¡ãƒ¢ãƒªã¨ä½µã›ã¦Inferentiaãƒãƒƒãƒ—ã®æ§˜å­ã‚‚ç›£è¦–ã—ãŸã„ã§ã™ã‚ˆã­ã€‚
ã—ã‹ã—Cloud Watchã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’æ¢ã—ã¦ã‚‚ãƒãƒƒãƒ—ã«é–¢ã™ã‚‹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

[AWS Neuronã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://awsdocs-neuron.readthedocs-hosted.com/en/latest/tools/neuron-sys-tools/neuron-monitor-user-guide.html#neuron-monitor-user-guide)ã‚’ç†Ÿèª­ã—ã¦ã„ãŸã‚‰neuron-monitorã‚³ãƒãƒ³ãƒ‰ã‚’ç”¨ã„ã¦Cloud Watchã¸ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’é€ä¿¡ã™ã‚‹æ–¹æ³•ãŒæ›¸ã‹ã‚Œã¦ã„ãŸã®ã§è©¦ã—ã¦ã¿ã¾ã™ã€‚

## å®Ÿè¡Œç’°å¢ƒ
| ãƒã‚·ãƒ³ã‚¿ã‚¤ãƒ— | AMI |
| ---- | ---- | 
| inf1.xlarge | Deep Learning AMI Neuron PyTorch 1.11.0 (Ubuntu 20.04) 20221107 | 

## neuron-monitor
neuron-monitorã¯AWS Neuronã«é–¢ã™ã‚‹æƒ…å ±ã‚’å–å¾—ã§ãã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚
æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™^[jqã‚³ãƒãƒ³ãƒ‰ã¯è¦‹ã‚„ã™ãã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¦ã„ã¾ã™]ã€‚
```sh
$ neuron-monitor  | jq
```
:::details å‡ºåŠ›çµæœ
```json
{
  "neuron_runtime_data": [
    {
      "pid": 41298,
      "neuron_runtime_tag": "",
      "error": "",
      "report": {
        "execution_stats": {
          "period": 0.070935409,
          "error_summary": {
            "generic": 0,
            "numerical": 0,
            "transient": 0,
            "model": 0,
            "runtime": 0,
            "hardware": 0
          },
          "execution_summary": {
            "completed": 0,
            "completed_with_err": 0,
            "completed_with_num_err": 0,
            "timed_out": 0,
            "incorrect_input": 0,
            "failed_to_queue": 0
          },
          "latency_stats": {
            "total_latency": null,
            "device_latency": null
          },
          "error": ""
        },
        "memory_used": {
          "period": 0.070905372,
          "neuron_runtime_used_bytes": {
            "host": 626905088,
            "neuron_device": 0,
            "usage_breakdown": {
              "host": {
                "application_memory": 626905088,
                "constants": 0,
                "dma_buffers": 0,
                "tensors": 0
              },
              "neuroncore_memory_usage": {
                "0": {
                  "constants": 0,
                  "model_code": 0,
                  "model_shared_scratchpad": 0,
                  "runtime_memory": 0,
                  "tensors": 0
                },
                "1": {
                  "constants": 0,
                  "model_code": 0,
                  "model_shared_scratchpad": 0,
                  "runtime_memory": 0,
                  "tensors": 0
                },
                "2": {
                  "constants": 0,
                  "model_code": 0,
                  "model_shared_scratchpad": 0,
                  "runtime_memory": 0,
                  "tensors": 0
                },
                "3": {
                  "constants": 0,
                  "model_code": 0,
                  "model_shared_scratchpad": 0,
                  "runtime_memory": 0,
                  "tensors": 0
                }
              }
            }
          },
          "loaded_models": [
            {
              "name": "XXXXXXXXXXXXXXX",
              "uuid": "XXXXXXXXXXXXXXXX",
              "model_id": 10002,
              "is_running": false,
              "subgraphs": {
                "sg_00": {
                  "memory_used_bytes": {
                    "host": 20416944,
                    "neuron_device": 17303308,
                    "usage_breakdown": {
                      "host": {
                        "application_memory": 20404608,
                        "constants": 0,
                        "dma_buffers": 12336,
                        "tensors": 0
                      },
                      "neuron_device": {
                        "constants": 121408,
                        "model_code": 0,
                        "runtime_memory": 0,
                        "tensors": 1039040
                      }
                    }
                  },
                  "neuroncore_index": 3,
                  "neuron_device_index": 0
                }
              }
            }
          ],
          "error": ""
        },
        "neuron_runtime_vcpu_usage": {
          "period": 0.070951414,
          "vcpu_usage": {
            "user": 0,
            "system": 0
          },
          "error": ""
        },
        "neuroncore_counters": {
          "period": 0.070980417,
          "neuroncores_in_use": {
            "0": {
              "neuroncore_utilization": 0
            },
            "1": {
              "neuroncore_utilization": 0
            },
            "2": {
              "neuroncore_utilization": 0
            },
            "3": {
              "neuroncore_utilization": 0
            }
          },
          "error": ""
        }
      }
    }
  ],
  "system_data": {
    "memory_info": {
      "period": 0.069966933,
      "memory_total_bytes": 8025300992,
      "memory_used_bytes": 2521931776,
      "swap_total_bytes": 0,
      "swap_used_bytes": 0,
      "error": ""
    },
    "neuron_hw_counters": {
      "period": 0.06997763,
      "neuron_devices": [
        {
          "neuron_device_index": 0,
          "mem_ecc_corrected": 0,
          "mem_ecc_uncorrected": 0,
          "sram_ecc_uncorrected": 0,
          "sram_ecc_corrected": 0
        }
      ],
      "error": ""
    },
    "vcpu_usage": {
      "period": 0.069988574,
      "average_usage": {
        "user": 0,
        "nice": 0,
        "system": 0,
        "idle": 100,
        "io_wait": 0,
        "irq": 0,
        "soft_irq": 0
      },
      "usage_data": {
        "0": {
          "user": 0,
          "nice": 0,
          "system": 0,
          "idle": 100,
          "io_wait": 0,
          "irq": 0,
          "soft_irq": 0
        },
        "1": {
          "user": 0,
          "nice": 0,
          "system": 0,
          "idle": 100,
          "io_wait": 0,
          "irq": 0,
          "soft_irq": 0
        },
        "2": {
          "user": 0,
          "nice": 0,
          "system": 0,
          "idle": 100,
          "io_wait": 0,
          "irq": 0,
          "soft_irq": 0
        },
        "3": {
          "user": 0,
          "nice": 0,
          "system": 0,
          "idle": 100,
          "io_wait": 0,
          "irq": 0,
          "soft_irq": 0
        }
      },
      "context_switch_count": 704,
      "error": ""
    }
  },
  "instance_info": {
    "instance_name": "",
    "instance_id": "i-XXXXXXXXXXXXX",
    "instance_type": "inf1.xlarge",
    "instance_availability_zone": "ap-northeast-1a",
    "instance_availability_zone_id": "apne1-az4",
    "instance_region": "ap-northeast-1",
    "ami_id": "ami-0442925238f84cec5",
    "subnet_id": "subnet-XXXXXXXXXXXXXXX",
    "error": ""
  },
  "neuron_hardware_info": {
    "neuron_device_count": 1,
    "neuroncore_per_device_count": 4,
    "error": ""
  }
}
```
:::
èª­ã¿è¾¼ã¾ã‚ŒãŸãƒ¢ãƒ‡ãƒ«æƒ…å ±ãªã©ã®æ§˜ã€…ãªæƒ…å ±ãŒå–å¾—ã§ãã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚
è©³ã—ãã¯[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://awsdocs-neuron.readthedocs-hosted.com/en/latest/tools/neuron-sys-tools/neuron-monitor-user-guide.html)ã‚’å¾¡è¦§ãã ã•ã„ã€‚ä¸€ã¤ä¸€ã¤ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®èª¬æ˜ãŒã‚ã‚Šã¾ã™ã€‚
4ã¤ã‚ã‚‹neuroncore_utilizationãŒNeuronã®å„Coreã®ä½¿ç”¨ç‡ã§ã™ã€‚

## å¿…è¦ãªæ¨©é™
ä¸€èˆ¬çš„ãªã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã«å¿…è¦ãªã‚‚ã®ã¨åŒã˜ã§ã™ãŒä»¥ä¸‹ã®æ¨©é™ãŒå¿…è¦ã§ã™ã€‚

cloudwatch:PutMetricData
cloudwatch:GetMetricStatistics
cloudwatch:ListMetrics
ec2:DescribeTags


## Cloud Watchã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’é€ã‚‹

[AWS Neuronã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://awsdocs-neuron.readthedocs-hosted.com/en/latest/tools/neuron-sys-tools/neuron-monitor-user-guide.html#using-neuron-monitor-cloudwatch-py)ã«æ›¸ã„ã¦ã‚ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”¨ã„ã¦ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¦ã‚©ãƒƒãƒã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’é€ã£ã¦ã¿ã¾ã™ã€‚
`neuron-monitor-cloudwatch.py`ã¨ã„ã†ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯Neuroné–¢ä¿‚ã®AMIã«ã¯ã˜ã‚ã‹ã‚‰ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã§ã™ã€‚
```sh
cd /opt/aws/neuron/bin
neuron-monitor | neuron-monitor-cloudwatch.py --region ap-northeast-1
```

![](https://storage.googleapis.com/zenn-user-upload/cfb2df991aa9-20221217.png)
*4ã¤ã®NeuronCoreã®ä½¿ç”¨ç‡ãŒå–å¾—ã§ãã¦ã„ã‚‹æ§˜å­*
Neuron coreã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒå–å¾—ã§ãã¾ã—ãŸã€‚Inf1.xlargeãªã®ã§4ã‚³ã‚¢åˆ†ã§ã™ã€‚
ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒå–å¾—ã§ããŸã‚‚ã®ã®ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«é–¢ã™ã‚‹æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚


## ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æƒ…å ±ã”ã¨ã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹
`neuron-monitor-cloudwatch.py`ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¦‹ã‚‹ã¨`--common-dims`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ãˆã°instance_id, instance_type, ami_id, neuron_runtime_tagã¨ã„ã£ãŸdimensionsã‚’è¿½åŠ ã§ãã¾ã™ã€‚

:::details neuron-monitor-cloudwatch.pyã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
```sh
$ python neuron-monitor-cloudwatch.py --help
usage: neuron-monitor-cloudwatch.py [-h] [-n NAMESPACE] -r REGION [-d COMMON_DIMS] [--high-resolution-metrics]

optional arguments:
  -h, --help            show this help message and exit
  -n NAMESPACE, --namespace NAMESPACE
                        Cloudwatch namespace where to post metrics
  -r REGION, --region REGION
                        Region where to post metrics
  -d COMMON_DIMS, --common-dims COMMON_DIMS
                        Comma-separated list of dimensions to be attached to each metric. Available: instance_id, instance_type, ami_id,
                        neuron_runtime_tag
  --high-resolution-metrics
                        Use 1 second resolution metrics
```
:::

instance_idã¨instance_typeã‚’è¿½åŠ ã—ã¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’é€ã£ã¦ã¿ã¾ã™ã€‚
```sh
$ neuron-monitor | neuron-monitor-cloudwatch.py \
                   --common-dims instance_id,instance_type \
		   --region ap-northeast-1
```

instance_idã¨instance_typeã®DimensionãŒå¢—ãˆã¾ã—ãŸã€‚
![](https://storage.googleapis.com/zenn-user-upload/53786f2de222-20221218.png)

![](https://storage.googleapis.com/zenn-user-upload/7f3283310028-20221218.png)
KAZY-devã¨ã„ã†Nameã‚¿ã‚°ã‚’ã¤ã‘ãŸãƒã‚·ãƒ³ã‚¿ã‚¤ãƒ—Inf1.xlargeã®EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®Neuron Coreã®ä½¿ç”¨ç‡ãŒç¢ºèªã§ãã¾ã™ã€‚
ã“ã‚Œã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã”ã¨ã«ç›£è¦–ãŒã§ãã¾ã™ã­ã€‚
ã†ã‚Œã—ã„ã€‚

:::message
ãƒ‡ã‚£ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’å¢—ã‚„ã™ã¨ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®æ•°ãŒå¢—ãˆã‚‹ã®ã§æ–™é‡‘ã«ã¯æ³¨æ„ã‚’ã—ã¾ã—ã‚‡ã†ã€‚
:::
https://aws.amazon.com/jp/cloudwatch/pricing/

## ãã®ä»–
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯1åˆ†æ¯ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã«ãªã‚Šã¾ã™ãŒ`--high-resolution-metrics`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ãˆã°æ¯ç§’ã®é«˜è§£åƒåº¦ãªãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚‚é€ã‚Œã‚‹ã‚ˆã†ã§ã™ã€‚å®Ÿè£…ã‚’è¦‹ã‚‹ã¨StorageResolutionã¨ã„ã†å€¤ã‚’1ã«ã—ã¦ã„ã¾ã™ã€‚
https://aws.amazon.com/jp/blogs/news/new-high-resolution-custom-metrics-and-alarms-for-amazon-cloudwatch/

# ãŠã‚ã‚Šã«
Inf1ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ECSã§ä½¿ã†ã¨ãã¯ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã¨ã—ã¦ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å…¥ã‚Œã¦ãŠã‘ã°è‰¯ã•ãã†ã€‚
æ¬¡å›è©¦ã—ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/d4007ea4754e-20221218.png)
*KAZYColorfulSaurus*
